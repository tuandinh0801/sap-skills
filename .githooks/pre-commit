#!/bin/bash
# Git pre-commit hook for JSON schema validation
# Place in .githooks/pre-commit and install with: git config core.hooksPath .githooks

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"
SCHEMAS_DIR="$REPO_ROOT/schemas"
VALIDATION_SCRIPT="$REPO_ROOT/scripts/validate-json-schemas.sh"

echo ""
echo "ðŸ” Pre-commit validation: Checking JSON schemas..."
echo ""

# Check if validation script exists
if [ ! -f "$VALIDATION_SCRIPT" ]; then
    echo -e "${YELLOW}âš  Validation script not found, skipping JSON validation${NC}"
    exit 0
fi

# Check if ajv-cli is installed
if ! command -v ajv &> /dev/null; then
    echo -e "${YELLOW}âš  ajv-cli not installed. Install with: npm install -g ajv-cli ajv-formats${NC}"
    echo -e "${YELLOW}âš  Skipping JSON validation (will be caught by CI)${NC}"
    exit 0
fi

# Get list of changed JSON files
CHANGED_JSON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(json)$' || true)

if [ -z "$CHANGED_JSON_FILES" ]; then
    echo -e "${GREEN}âœ“ No JSON files changed, skipping validation${NC}"
    exit 0
fi

echo "Changed JSON files:"
echo "$CHANGED_JSON_FILES" | sed 's/^/  - /'
echo ""

# Track validation status
VALIDATION_FAILED=0

# Validate marketplace.json if changed
if echo "$CHANGED_JSON_FILES" | grep -q "\.claude-plugin/marketplace\.json"; then
    echo "ðŸ“‹ Validating marketplace.json..."
    if ajv validate \
        -s "$SCHEMAS_DIR/marketplace.schema.json" \
        -d "$REPO_ROOT/.claude-plugin/marketplace.json" \
        --strict=false \
        -c ajv-formats \
        --all-errors; then
        echo -e "${GREEN}âœ“ marketplace.json is valid${NC}"
    else
        echo -e "${RED}âœ— marketplace.json validation failed${NC}"
        VALIDATION_FAILED=1
    fi
    echo ""
fi

# Validate plugin.json files if changed
CHANGED_PLUGIN_JSON=$(echo "$CHANGED_JSON_FILES" | grep "plugin\.json" | grep -v "marketplace\.json" || true)

if [ -n "$CHANGED_PLUGIN_JSON" ]; then
    echo "ðŸ”§ Validating plugin.json files..."
    while IFS= read -r plugin_json; do
        PLUGIN_NAME=$(basename "$(dirname "$(dirname "$plugin_json")")")
        echo -n "  Validating $PLUGIN_NAME... "

        if ajv validate \
            -s "$SCHEMAS_DIR/plugin.schema.json" \
            -d "$REPO_ROOT/$plugin_json" \
            --strict=false \
            -c ajv-formats \
            --all-errors 2>&1 | grep -q "valid"; then
            echo -e "${GREEN}âœ“${NC}"
        else
            echo -e "${RED}âœ—${NC}"
            ajv validate \
                -s "$SCHEMAS_DIR/plugin.schema.json" \
                -d "$REPO_ROOT/$plugin_json" \
                --strict=false \
                -c ajv-formats \
                --all-errors || true
            VALIDATION_FAILED=1
        fi
    done <<< "$CHANGED_PLUGIN_JSON"
    echo ""
fi

# Final result
if [ $VALIDATION_FAILED -eq 1 ]; then
    echo -e "${RED}âŒ Pre-commit validation failed${NC}"
    echo ""
    echo "Fix the validation errors above, or bypass with: git commit --no-verify"
    echo "(Note: CI will still catch these errors even if you bypass)"
    echo ""
    exit 1
else
    echo -e "${GREEN}âœ… All validations passed${NC}"
    echo ""
    exit 0
fi
